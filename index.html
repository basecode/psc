<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - particles configurator</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000000;
				margin: 0px;
				text-align:center;
				font-family:arial;
				font-size:11px;
			}

			a {
				color:#0078ff;
			}

			#screen, #info {
				overflow:hidden;
				position:fixed;
			}

			#info {
				color: #fff;
				font-weight: bold;
				font-size:13px;
				font-family:Monospace;
				top: 0px; width: 100%;
				padding: 5px;
				z-index: 100;
			}

			.configPanel { 
				position:absolute;
				right:0;
				top:0;
				width:250px;
				padding:5px 10px;
				background-color:#ddd;
				border: 2px solid #222;
				display: block;
				margin: auto;
				z-index:100;
				text-align:left;
			}
			h3 {
				background-color:#d0a251;
				border-bottom:1px solid #b2841f;
				text-shadow: 1px 1px 0px #c09348;
				letter-spacing: 1px;
				margin:0;
				font-size:1em;
				text-align:center;
				padding:3px 0;
				color:#52120d;
			}
			h4 {
				background-color:#52120d;
				border-bottom:1px solid #ce2b14;
				text-shadow: 1px 1px 0px #000;
				letter-spacing: 1px;
				margin:0;
				text-align:center;
				padding:5px 0;
				color:#f3f3f3;
			}
			p {
				padding:5px;
				background-color:#E8E8E8;
				border-bottom:1px solid #ccc;
				margin:2px 0;
			}
			label {
				padding-right:5px;
			}
			input {
				width:45px;
			}
			input[name=EXPORT_LONG], input[name=EXPORT_SHORT], input[name=IMPORT] {
				width:170px;
			}

		</style>
	</head>
	<body>
    <div id="info">
		  <a href="http://github.com/mrdoob/three.js" target="_blank">three.js</a>
      - webgl particle system configurator by
      <a href="http://twitter.com/basecode">basecode</a>
		</div>

		<div id="screen"></div>

		<div class="configPanel">
			<h4>PREDEFINED CONFIGURATIONS</h4>
			<p>
					<select name="PREDEFINED_CONFIGURATIONS">
							<option value="burner">Burner</option>
							<option value="glitterParty">Glitter Party</option>
							<option value="blueGalaxy">Blue Galaxy</option>
							<option value="snow">Snow</option>
							<option value="somethingBlue">Something Blue</option>
							<option value="comet">Comet</option>
							<option value="colorfulSnow">Colorful Snow</option>
							<option value="waterFountain">Water Fountain</option>
							<option value="smoke">Smoke</option>
							<!--<option value="uxebu">uxebu</option>//-->
					</select>
			</p>
			<h4>PARTICLE CONFIGURATOR</h4>
			<p>
					<label>Particles:</label>
					<input type="number" min="0" name="intendedParticles" value="5" style="width:55px;">
			</p>
			<p>
					<label>Texture:</label>
					<select name="texture">
							<option value="fire">Fire</option>
							<option value="smoke">Smoke</option>
							<option value="snow">Snow</option>
							<option value="avatar">basecode</option>
							<option value="uxebu-logo">uxebu</option>
					</select>
			</p>
			<p>
					<label>Lifespan:</label>
					<input type="number" min="0" name="lifespan" value="2">
					, <label>Var:</label>
					<input type="number" min="0" name="lifespanVariance" value="0">
			</p>
			<p>
					<label>Startsize:</label>
					<input type="number" min="0" name="startSize" value="20">
					, <label class="two">Var:</label>
					<input type="number" min="0" name="startSizeVariance" value="0">
			</p>
			<p>
					<label>Endsize:</label>
					<input type="number" min="0" name="endSize" value="5">
					, <label>Var:</label>
					<input type="number" min="0" name="endSizeVariance" value="0">
			</p>
			<p>
					<label>Position X:</label>
					<input type="number" data-type="point" data-key="x" name="position" value="0">
					, <label>Var:</label>
					<input type="number" data-type="point" data-key="x" name="positionVariance" value="0">
			</p>
			<p>
					<label>Position Y:</label>
					<input type="number" data-type="point" data-key="y" name="position" value="0">
					, <label>Var:</label>
					<input type="number" data-type="point" data-key="y" name="positionVariance" value="0">
			</p>
			<h3>GRAVITY<!-- <a href="">(switch to Radius)</a>//--></h3>
			<p>
					<label>Speed:</label>
					<input type="number" name="speed" value="0">
					, <label>Var:</label>
					<input type="number" name="speedVariance" value="0">
			</p>
			<p>
					<label>Gravity X:</label>
					<input type="number" data-type="point" data-key="x" name="gravity" value="0">
					, <label>Y:</label>
					<input type="number" data-type="point" data-key="y" name="gravity" value="0">
			</p>
			<p>
					<label>Angle:</label>
					<input type="number" name="angle" value="0">
					, <label>Var:</label>
					<input type="number" name="angleVariance" value="0">
			</p>
			<p>
					<label>Radial Accel.:</label>
					<input type="number" name="radialAcceleration" value="0">
					, <label>Var:</label>
					<input type="number" name="radialAccelerationVariance" value="0">
			</p>
			<p>
					<label>Tang. Accel.:</label>
					<input type="number" name="tangentialAcceleration" value="0">
					, <label>Var:</label>
					<input type="number" name="tangentialAccelerationVariance" value="0">
			</p>
			<h3>COLOR RANGE (0-1)</h3>
			<p>
					<label>Startcolor Red:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="r" name="startColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="r" name="startColorVariance" value="0">
			</p>
			<p>
					<label>Startcolor Green:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="g" name="startColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="g" name="startColorVariance" value="0">
			</p>
			<p>
					<label>Startcolor Blue:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="b" name="startColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="b" name="startColorVariance" value="0">
			</p>
			<p>
					<label>Startcolor Alpha:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="a" name="startColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="a" name="startColorVariance" value="0">
			</p>
			<p>
					<label>Endcolor Red:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="r" name="endColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="r" name="endColorVariance" value="0">
			</p>
			<p>
					<label>Endcolor Green:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="g" name="endColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="g" name="endColorVariance" value="0">
			</p>
			<p>
					<label>Endcolor Blue:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="b" name="endColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="b" name="endColorVariance" value="0">
			</p>
			<p>
					<label>Endcolor Alpha:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="a" name="endColor" value="0">
					, <label>Var:</label>
					<input type="number" min="0" max="1" step="0.1" data-type="color" data-key="a" name="endColorVariance" value="0">
			</p>
			<h3>BLENDING</h3>
			<p>
					<select name="blending">
							<option value="NormalBlending">Normal</option>
							<option value="AdditiveBlending">Additive</option>
							<option value="SubtractiveBlending">Subtractive</option>
							<option value="MultiplyBlending">Multiply</option>
							<option value="AdditiveAlphaBlending">Additive Alpha</option>
					</select>
			</p>
			<h4>PERMALINK</h4>
			<p>
					LONG:&nbsp;&nbsp;&nbsp;<input type="text" name="EXPORT_LONG" value="">
			</p>
			<p>
					SHORT: <input type="text" name="EXPORT_SHORT" value="">
					<input style="margin-left:45px; width:180px;" type="button" name="GENERATE_SHORT_URL" value="generate a short url">
			</p>
			<!--
			<h4>IMPORT</h4>
			<p>
					<input type="text" name="IMPORT" value="">
					<button name="IMPORT">OK</button>
			</p>
			//-->
	</div>

<script src="three.js/build/Three.js"></script>
<script src="PSCParticleSystem.js"></script>
<script src="PSCVertex.js"></script>
<script src="predefined_configurations.js"></script>

<script src="WebGestureRecognizers/onUserInteractionMove.js"></script>
<script src="three.js/examples/js/Detector.js"></script>
<script src="three.js/examples/js/RequestAnimationFrame.js"></script>
<script src="three.js/examples/js/Stats.js"></script>

<script type="x-shader/x-vertex" id="vertexshader">

	attribute float size;
	attribute vec3 ca;

	varying vec3 vColor;

	void main() {

		vColor = ca;

		vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

		//gl_PointSize = size;
		gl_PointSize = size * ( 400.0 / length( mvPosition.xyz ) );

		gl_Position = projectionMatrix * mvPosition;

	}

</script>

<script type="x-shader/x-fragment" id="fragmentshader">

	uniform vec3 color;
	uniform sampler2D texture;

	varying vec3 vColor;

	void main() {

		gl_FragColor = vec4( color * vColor, 1.0 );
		gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );

	}

</script>

<script type="text/javascript">

	if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

	var stats;
	var CREATE_NEW_PARTICLE_SYSTEM = 1, USE_EXISTING_PARTICLE_SYSTEM = 2;
	var camera, scene, renderer, parameters, i, particleSystem;
	var configurator = Object.create(null);
	var windowHalfX = window.innerWidth / 2;
	var windowHalfY = window.innerHeight / 2;

	// import config file from document.location.hash
	(function(w, hash) {
			hash = hash && hash.length > 10 && unescape(hash.substr(1));
			if (hash) {
					try {
							setConfig(JSON.parse(hash));
					} catch(e){
							console.error("sorry, but this isn't a valid configuration.");
							hash = false;
					}
			}
			w.hasHashConfig = function() {
				return !!hash;
			}
	})(window, document.location.hash);

	// seems not to fix the CORS issue with firefox, safari, webkit nighlty
	// see: https://github.com/mrdoob/three.js/issues/687
	(function(w, aImage, aContext) {
		var loaded = function() {
			aContext.canvas.width = aImage.width;
			aContext.canvas.height = aImage.height;
			aContext.drawImage(aImage, 0, 0);
			aImage.callback(aContext.canvas);
		}
		var base64FromImageId = {
			'fire' : 'iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAAK/INwWK6QAAAy1JREFUWAnF1+dSW0EQhFHjnP3+r+mc8RyhTywKCPOHqZq6e/fOdveEFcXF5eXlo4e0p/cgfzFnHo9fbF0G/O/4j/H/sos7VgDps3GC+ZPxfQF/Zu/31n/N805izlXg+QBxAlonoiqUfeQ/J5YT3HqWx+02AS/nSP5q1kQkZK0CAWWPUOb82/j3cUI9j9opAQj568W9E0TEKQGIkSGvZVXK3oEdE4AE2Zvxt1u3JsZ+VWgOqkDZIxJDQDGz3AzqQSX2BegzAciQvx9/t10nwveyM4gE6L/BQ/B1HA5s2bPmxE0hdGfnBCAnghNE2DkBZR850maE0JMCHOT1vhasAuzVBlWoAl075V8zR151xOS7K7pWAGBXbl+E7NdW+C5WlpW1wVszR9hsaI8zeI4KICYBDWK3oGp8mBhC7KtWAgDqfQmV+XorxMMvZpbXLz76sIqwR0hiiEBOhIrYN+X6KzuZsUqOXAyclRyH900VUiMTYIlICFDuQG3pdqiCOISyZ0pOTO1wtqzDxlObNgDzvvtdT4igVVBAhMgKuWrYR8r0ukztr4Thwe9vyCyvlbR529PhBAJHoi2RldlKchveHL0W4IfinBss3p2W+ZdxT22wX8w5LN83JhPWgQiARdRQrdepnjvfDOi9wRKXqISFBz+uWV71yTNiB/KAgAE2WIiVnPmu7MCRfx73XZx457i4MBOEb2NVwAFTLsAB7xzwOtXFAzZw+g1MLPJP49pCRGfDWoXY21iAXlbySIEiEoeMifPd9UoAcKTIVcLT2SoiHmkiZnllq4DKJRDYeqUil60437XClOupvc4lYhUiPgFid7YKEAA08K7XSi774pxNgH3AMpU18o/bZ9VIhPM7WwXYVCIg9rvXs9z0uSz9ECXulICqYCYaTrjwb9gxATLmwJmyNx9Aag2BCXATgMtOpqqQiP8SMOc2FYhcf4GXPfCGcl9A7SEyEfuDOJ9u2n4F+goAednX37KvRWsFqpIqVAli8lke2ikBIh1cBbh261+22rQKTUTt8Dzo++zt7MH/M7qrgJ3iWWhD2deCqnDjiq2HTq3vI+AU1r32ZfKg9g+4IXKJrhPF1wAAAABJRU5ErkJggg=='
		}
		w.makeOrigin = function(imageId, callback) {
			if (imageId in base64FromImageId) {
				aImage.src = 'data:image/png;base64,' + base64FromImageId[imageId];
			} else {
				aImage.src = 'textures/' + imageId + '.png';
			}
			aImage.callback = callback;
			(aImage.complete) ? loaded() : aImage.onload = loaded;
		}
	})(window, new Image(), document.createElement('canvas').getContext('2d'));

	// setup three.js
	(function init(win, doc) {
		var container = doc.getElementById('screen');

		// Camera params:
		// field of view, aspect ratio for render output, near and far clipping plane. 
		camera = new THREE.PerspectiveCamera(90);
		// move the camera backwards so we can see stuff!
		camera.position.z = 300;

		// the scene contains all the 3D object data
		scene = new THREE.Scene();
		//scene.fog = new THREE.FogExp2( 0x000000, 0.0007 );

		// set configuration
		if (!hasHashConfig()) {
			setConfig(PREDEFINED_CONFIGURATIONS.burner);
		}

		// init a new particle system
		newParticleSystem();

		renderer = new THREE.WebGLRenderer({ clearColor: 0x000000, clearAlpha: 1 });
		renderer.setSize(win.innerWidth, win.innerHeight);

		//master
		//renderer.sortElements = false;

		//dev
		//renderer.autoClear = false;
		//renderer.sortObjects = false;

		//renderer.setClearColorHex( 0x000000, 0.25 );

		container.appendChild(renderer.domElement);

		/**
			user interaction proxy (mouse/touch)
			@dependencies container
		*/
		onUserInteractionMove(container, function(obj) {
			var pos = obj.position.page;

			camera.position.x += ( pos.x - camera.position.x ) * 0.05;
			camera.position.y += ( - pos.y - camera.position.y ) * 0.05;
			camera.lookAt( scene.position );

			//var newPos = {x:pos.x - windowHalfX, y:-1*pos.y + windowHalfY};
			//updateConfig('position', newPos, USE_EXISTING_PARTICLE_SYSTEM);
			//particleSystem.liveConfigUpdate(configurator);
		});

		/**
			setup stats
			@dependencies container
		*/
		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		container.appendChild( stats.domElement );

	})(window, document);

	function newParticleSystem() {
		
		makeOrigin(configurator.texture, function(img) {
			
			particleSystem && scene.remove(particleSystem);
	
			var attributes = {
				size: {	type: 'f', value: [] },
				ca:   {	type: 'c', value: [] }
			};

			texture = new THREE.Texture(img);
			texture.needsUpdate = true;

			var uniforms = {
				amplitude:  { type: "f", value: 1.0 },
				color:      { type: "c", value: new THREE.Color( 0xffffff ) },
				texture:    { type: "t", value: 0, texture: texture },
				transparent:{ type: "b", value: true},
			};

			// what does that mean?
			uniforms.texture.texture.wrapS = uniforms.texture.texture.wrapT = THREE.RepeatWrapping;
	
			/** setup particles */
			
			/*var material = new THREE.ParticleBasicMaterial({
				color: 0xFFFFFF,
				size: 290,
				map: THREE.ImageUtils.loadTexture(configurator.texture),
				blending: THREE[configurator.blending],
				transparent: true,
				vertexColors: true
			});*/
	
			var material = new THREE.ShaderMaterial( {
				uniforms: uniforms,
				attributes: attributes,
				vertexShader: document.getElementById( 'vertexshader' ).textContent,
				fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
				blending: THREE[configurator.blending],
				depthTest: 		false,
				transparent:	true
			});
	
			var particles = new THREE.Geometry();
			
			for (var i = 0, colors = [], len = configurator.intendedParticles, particle; i < len; i++ ) {
				particle = new PSCVertex(configurator);
				particles.vertices[i] = particle;
				//setup particle color
				colors[i] = new THREE.Color();
			}
			particles.colors = colors;
			
			/** setup particle system */
			particleSystem = new PSCParticleSystem(particles, material, configurator);
	
			scene.add(particleSystem);
		});
	}

	(function animate(timestamp) {

		var sceneObjects = scene.objects;
		var i = sceneObjects.length;
		while(i-->0) {
			if (sceneObjects[i] instanceof PSCParticleSystem) {
				// refresh psc particle system
				sceneObjects[i].refresh(timestamp);
			}
		}

		renderer.clear();
		renderer.render( scene, camera );
		stats.update();
		requestAnimationFrame( animate );

		return;

	})(+new Date);
	
	// a lot of configuration stuff

	function setConfig(conf) {
		for (var key in conf) {
			updateConfig(key, conf[key], USE_EXISTING_PARTICLE_SYSTEM);
		}
	}
	
	function updateConfig() {
			
		var key = arguments[0] || "";
		var value = arguments[1] || "";
		var createNewParticleSystemFlag = arguments[2] || CREATE_NEW_PARTICLE_SYSTEM;
		
		if (key.length) {
				configurator[key] = value;
		}
		
		// Point
		if (value && typeof value.x === "number") {
				document.querySelector('input[name='+key+'][data-key=x]').value = value.x;
				document.querySelector('input[name='+key+'][data-key=y]').value = value.y;
		}
		
		// Color
		if (value && typeof value.red === "number") {
				document.querySelector('input[name='+key+'][data-key=r]').value = value.red;
				document.querySelector('input[name='+key+'][data-key=g]').value = value.green;
				document.querySelector('input[name='+key+'][data-key=b]').value = value.blue;
				document.querySelector('input[name='+key+'][data-key=a]').value = value.alpha;
		}
		
		//numbers
		if (value && typeof value === "number") {
				var inputNumber = document.querySelector('input[name='+key+']');
				if (inputNumber && inputNumber.value) {
						inputNumber.value = value;
				}
		}
		
		// texture
		if (value && key && key === 'texture') {
				document.querySelector('select[name=texture]').selectedIndex = 
				document.querySelector('select[name=texture]').querySelector('option[value='+value+']').index;
		}
		
		// blending
		if (key && key === 'blending') {
				document.querySelector('select[name=blending]').selectedIndex = 
				document.querySelector('select[name=blending]').querySelector('option[value='+value+']').index;
		}
		
		document.querySelector('input[name=EXPORT_LONG]').value = "http://basecode.github.com/psc#"+JSON.stringify(configurator);
		
		(createNewParticleSystemFlag === CREATE_NEW_PARTICLE_SYSTEM) && newParticleSystem();
	}
	
	// configurator: handle ui input-element changes
	for (var i = 0, els = document.getElementsByTagName('input'), len = els.length; i < len; i++) {
			els[i].addEventListener("input", function handleUIInputElementChanges(e) {
					var t = e.target;
					console.log(t.type, t.name, t.value);
					
					// Points
					if (t.getAttribute('data-type') && t.getAttribute('data-type') === 'point') {
							var x = +document.querySelector('input[name='+t.name+'][data-key=x]').value;
							var y = +document.querySelector('input[name='+t.name+'][data-key=y]').value;
							updateConfig(t.name, {x : x, y : y});
							return;
					}
					
					// Colors
					if (t.getAttribute('data-type') && t.getAttribute('data-type') === 'color') {
							var r = +document.querySelector('input[name='+t.name+'][data-key=r]').value;
							var g = +document.querySelector('input[name='+t.name+'][data-key=g]').value;
							var b = +document.querySelector('input[name='+t.name+'][data-key=b]').value;
							var a = +document.querySelector('input[name='+t.name+'][data-key=a]').value;
							updateConfig(t.name, {red : r, green : g, blue : b, alpha : a});
							return;
					}
							
					//numbers
					if (t.type === 'number') {
							updateConfig(t.name, +t.value);
					}
			}, false);
	};
	
	// configurator: handle ui select-box changes
	for (var i = 0, els = document.getElementsByTagName('select'), len = els.length; i < len; i++) {
			els[i].addEventListener("change", function handleUISelectBoxChanges(e) {
					
					var t = e.target;
					
					// predefined configurations
					if (t.name === "PREDEFINED_CONFIGURATIONS" && PREDEFINED_CONFIGURATIONS[t.value]) {
							setConfig(PREDEFINED_CONFIGURATIONS[t.value]);
							newParticleSystem();
							return;
					}
	
					updateConfig(t.name, t.value, USE_EXISTING_PARTICLE_SYSTEM);
					newParticleSystem();
	
			}, false);
	};
</script>

<script type="text/javascript">
if (window.location.hostname !== "localhost" && window.location.hostname !== "127.0.0.1") {
		//google analytics
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-24324453-1']);
		_gaq.push(['_trackPageview']);
		
		(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
}
</script>

	</body>
</html>
